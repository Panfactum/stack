import ModuleHeader from "../../../ModuleHeader";

{/* lint disable no-duplicate-headings */}

{/* eslint-disable import/order */}

<ModuleHeader name="kube_pg_cluster" sourceHref="https://github.com/Panfactum/stack/tree/__PANFACTUM_VERSION_MAIN__/packages/infrastructure/kube_pg_cluster" status="stable" type="submodule" />

# PostgreSQL Cluster on Kubernetes

import MarkdownAlert from "@/components/markdown/MarkdownAlert";

## Usage

### Storage

You must provide an initial storage amount for the database with `pg_initial_storage_gb`. This configures the size
of the underlying EBS volumes.

Once the database is running, the PVC autoresizer
(provided by [kube\_pvc\_autoresizer](/docs/main/reference/infrastructure-modules/direct/kubernetes/kube_pvc_autoresizer))
will automatically expand the EBS volumes once the free space
drops below `pg_storage_increase_threshold_percent` of the current EBS volume size.
The size of the EBS volume will grow by `pg_storage_increase_gb` on every scaling event until a maximum of `pg_storage_limit_gb`.

Note that a scaling event can trigger **at most once every 6 hours** due to an AWS limitation. As a result,
ensure that `pg_storage_increase_gb` is large enough to satisfy your data growth rate.

### Memory Tuning

By default, we tune the PostgreSQL memory settings in accordance with
[the EDB recommendations](https://www.enterprisedb.com/postgres-tutorials/how-tune-postgresql-memory) since EDB
is the original creator of CNPG.

However, PostgreSQL databases can be used to run such a wide array of workloads that you may want to tune
the settings further for your particular use case.

These three settings are the most important:

* `pg_work_mem_percent`: How much memory is set aside for intermediate calculations in a query (i.e., sorts, joins, etc.).
* `pg_max_connections`: How many simultaneous connections / queries you can run in the database.
* `pg_shared_buffers_percent`: How much of the memory given to the cluster is set aside for caching data so that
  it does not need to be read from disk.

`pg_work_mem_percent` is the most important and most likely to slow down your complex queries. This parameter
represents the total memory set aside for all connections for their query calculations.

`pg_max_connections` is important as memory is allocated and limited on a *per-operation* basis.
As a result, the actual memory available to each query is roughly `pg_memory_mb * pg_work_mem_percent / pg_max_connections`.
This is true regardless of whether you are
actually using the maximum number of connections. Therefore, if you are using the database
to run large analytical queries, you may want to lower the `pg_max_connections` value in order to allow each query to use more
of the working memory pool.

`pg_shared_buffers_percent` will not typically be a source of issues as the linux page cache will step in if
this value is not large enough. However, the internal PostgreSQL cache controlled by this value
will always be more performant than the generic page cache, so tuning this can help in some circumstances.

### Shutdowns and Failovers

Postgres has [three shutdown modes](https://www.postgresql.org/docs/current/server-shutdown.html):

* Smart Shutdown: Prevents new connections, but allows existing sessions to finish their work before
  shutting down.
* Fast Shutdown: Prevents new connections and forces all existing sessions to abort safely before
  shutting down.
* Immediate Shutdown: Immediately exits without doing normal database shutdown processing (including
  forcibly killing sessions w/ doing graceful aborts). Forces a database recovery operation on the next
  startup.

The default behavior of this module is to do a fast shutdown with a 30-second timeout (`pg_switchover_delay`)
until an immediate shutdown is issued.

When running with a replica, this results in at most 30 seconds of downtime if the primary
instance is terminated (the replicas are still readable); however, it will normally be around
5 seconds.

This is quite quick, but the downside is that any running queries on the primary will be immediately
terminated and not allowed to complete. You can increase the amount of time that running queries
are allowed to complete by increasing `pg_smart_shutdown_timeout`. However, this will increase the
time that *new* sessions cannot be made with database proportionally (i.e., setting `pg_smart_shutdown_timeout`
to `30` will allow 30 seconds for existing queries to complete but increase the amount of time that new
queries cannot be made to about 35 seconds).

We generally recommend keeping
`pg_smart_shutdown_timeout` set to the default `1` (minimum allowed by CNPG) in order to minimize downtime.
Instead of trying to ensure queries
will always complete, we recommend that you implement retry logic in your database client code. This will
not only add resilience to this particular scenario, but will also be beneficial in other failure modes.

For more information about shutdowns, please see the [CNPG documentation.](https://cloudnative-pg.io/documentation/1.23/instance_manager/)

### Disruptions

By default, failovers of PostgreSQL pods in this module can be initiated at any time. This enables the cluster to automatically
perform maintenance operations such as instance resizing, AZ re-balancing, version upgrades, etc. However, every time a PostgreSQL pod
is disrupted, running queries will be terminated prematurely and a short period of downtime might occur if the disrupted
pod is the primary instance (see the Shutdowns and Failovers section).

You may want to provide more control over when these failovers can occur, so we provide the following options:

#### Disruption Windows

Disruption windows provide the ability to confine disruptions to specific time intervals (e.g., periods of low load) if this is needed
to meet your stability goals. You can enable this feature by setting `voluntary_disruption_window_enabled` to `true`.

The disruption windows are scheduled via `voluntary_disruption_window_cron_schedule` and the length of time of each
window via `voluntary_disruption_window_seconds`.

If you use this feature, we *strongly* recommend that you allow disruptions at least once per day, and ideally more frequently.

For more information on how this works, see the
[kube\_disruption\_window\_controller](/docs/main/reference/infrastructure-modules/submodule/kubernetes/kube_disruption_window_controller)
submodule.

#### Custom PDBs

Rather than time-based disruption windows, you may want more granular control of when disruptions are allowed and disallowed.

You can do this by managing your own [PodDisruptionBudgets](https://kubernetes.io/docs/tasks/run-application/configure-pdb/).
This module provides outputs that will allow you to match certain subsets of pods for both PostgreSQL and PgBouncer.

For example:

```hcl
module "database" {
  source = "github.com/Panfactum/stack.git//packages/infrastructure/kube_pg_cluster?ref=__PANFACTUM_VERSION_MAIN__" # pf-update
  ...
}

resource "kubectl_manifest" "pdb" {
  yaml_body = yamlencode({
    apiVersion = "policy/v1"
    kind       = "PodDisruptionBudget"
    metadata = {
      name      = "custom-pdb"
      namespace = module.database.namespace
    }
    spec = {
      unhealthyPodEvictionPolicy = "AlwaysAllow"
      selector = {
        matchLabels = module.database.cluster_match_labels # Selects all PostgreSQL pods
      }
      maxUnavailable = 0 # Prevents any disruptions
    }
  })
  force_conflicts   = true
  server_side_apply = true
}
```

While this example is constructed via IaC, you can also create / destroy these PDBs directly in your application
logic via YAML manifests and the Kubernetes API. This would allow you to create a PDB prior to initiating a long-running
query that you do not want disrupted and then delete it upon completion.

#### Completely Disabling Voluntary Disruptions

Allowing the cluster to periodically initiate failovers of PostgreSQL is critical to maintaining system health. However,
there are rare cases where you want to override the safe behavior and disable voluntary disruptions altogether. Setting
the `voluntary_disruptions_enabled` to `false` will set up PDBs that disallow any voluntary disruption of either PostgreSQL
or PgBouncer pods.

This is *strongly* discouraged. If limiting any and all potential disruptions is of primary importance you should instead:

* Create a one-hour weekly disruption window to allow *some* opportunity for automatic maintenance operations
* Ensure that `spot_instances_enabled` and `burstable_instances_enabled` are both set to `false`
* Connect through PgBouncer with `pgbouncer_pool_mode` set to `transaction`
* Set `enhanced_ha_enabled` to `true`

Note that the above configuration will significantly increase the costs of running PostgreSQL (2.5-5x) versus more
flexible settings. In the vast majority of cases, this is entirely unnecessary, so this should only be used as a last resort.

<MarkdownAlert severity="warning">
  Enabling PDBs either manually or via disruption windows will not prevent all forms of disruption, only *voluntary* ones. A voluntary
  disruption is one that is done through the [Eviction API](https://kubernetes.io/docs/concepts/scheduling-eviction/api-eviction/)
  and limited by the use of PDBs.

  An example of a non-voluntary disruption would be via spot node termination or resource constraints. As a result,
  you should still implement defensive coding practices in your client code to account for potential disruptions.
</MarkdownAlert>

### PostgreSQL Parameters

PostgreSQL comes with hundreds of parameters that can be used to customize its behavior. You
can see the full set of available values [here](https://cloudnative-pg.io/documentation/1.23/postgresql_conf), and you
can provide them to this module via `pg_parameters`.

This can be used overwrite any default settings this module provides.

### Extra Schemas

When initially created, the CNPG cluster has just one [schema](https://www.postgresql.org/docs/current/ddl-schemas.html)
(`public`) in the `app` database. However, you may choose to add more in the future.

If you do, you will need to add those schemas to the `extra_schemas` input. This will ensure that users and roles
created by the Vault auth system will have access to the objects in those schemas.

Note that this will NOT create the extra schemas; you should do that in your database migration scripts.

## Providers

The following providers are needed by this module:

* [aws](https://registry.terraform.io/providers/hashicorp/aws/5.39.1/docs) (5.39.1)

* [kubectl](#requirement_kubectl) (2.0.4)

* [kubernetes](https://registry.terraform.io/providers/hashicorp/kubernetes/2.27.0/docs) (2.27.0)

* [random](https://registry.terraform.io/providers/hashicorp/random/3.6.0/docs) (3.6.0)

* [time](https://registry.terraform.io/providers/hashicorp/time/0.10.0/docs) (0.10.0)

* [vault](https://registry.terraform.io/providers/hashicorp/vault/3.25.0/docs) (3.25.0)

## Required Inputs

The following input variables are required:

### <a name="input_aws_iam_ip_allow_list" /> [aws\_iam\_ip\_allow\_list](#input_aws_iam_ip_allow_list)

Description: A list of IPs that can use the service account token to authenticate with AWS API

Type: `list(string)`

### <a name="input_eks_cluster_name" /> [eks\_cluster\_name](#input_eks_cluster_name)

Description: The name of the EKS cluster.

Type: `string`

### <a name="input_pg_cluster_namespace" /> [pg\_cluster\_namespace](#input_pg_cluster_namespace)

Description: The namespace to deploy to the cluster into

Type: `string`

### <a name="input_pg_initial_storage_gb" /> [pg\_initial\_storage\_gb](#input_pg_initial_storage_gb)

Description: The initial number of gigabytes of storage to provision for the postgres cluster

Type: `number`

## Optional Inputs

The following input variables are optional (have default values):

### <a name="input_arm_instances_enabled" /> [arm\_instances\_enabled](#input_arm_instances_enabled)

Description: Whether the database nodes can be scheduled on arm instances

Type: `bool`

Default: `false`

### <a name="input_backups_cron_schedule" /> [backups\_cron\_schedule](#input_backups_cron_schedule)

Description: The cron schedule on which to create CNPG Backup resources

Type: `string`

Default: `"0 0 0 * * 0"`

### <a name="input_backups_enabled" /> [backups\_enabled](#input_backups_enabled)

Description: Whether this database has backups enabled

Type: `bool`

Default: `true`

### <a name="input_backups_force_delete" /> [backups\_force\_delete](#input_backups_force_delete)

Description: Whether to delete backups on destroy

Type: `bool`

Default: `false`

### <a name="input_burstable_instances_enabled" /> [burstable\_instances\_enabled](#input_burstable_instances_enabled)

Description: Whether the database nodes can be scheduled on burstable instances

Type: `bool`

Default: `false`

### <a name="input_enhanced_ha_enabled" /> [enhanced\_ha\_enabled](#input_enhanced_ha_enabled)

Description: Whether to add extra high-availability scheduling constraints at the trade-off of increased cost

Type: `bool`

Default: `true`

### <a name="input_extra_schemas" /> [extra\_schemas](#input_extra_schemas)

Description: Extra schemas that were created in the app database

Type: `list(string)`

Default: `[]`

### <a name="input_monitoring_enabled" /> [monitoring\_enabled](#input_monitoring_enabled)

Description: Whether to add active monitoring to the deployed systems

Type: `bool`

Default: `false`

### <a name="input_panfactum_scheduler_enabled" /> [panfactum\_scheduler\_enabled](#input_panfactum_scheduler_enabled)

Description: Whether to use the Panfactum pod scheduler with enhanced bin-packing

Type: `bool`

Default: `false`

### <a name="input_pg_cpu_millicores" /> [pg\_cpu\_millicores](#input_pg_cpu_millicores)

Description: The amount of cpu to allocate to the postgres pods (in millicores)

Type: `number`

Default: `250`

### <a name="input_pg_instances" /> [pg\_instances](#input_pg_instances)

Description: The number of instances to deploy in the postgres cluster

Type: `number`

Default: `2`

### <a name="input_pg_maintenance_work_mem_percent" /> [pg\_maintenance\_work\_mem\_percent](#input_pg_maintenance_work_mem_percent)

Description: The percent of the overall memory allocation available for database maintenance operations

Type: `number`

Default: `5`

### <a name="input_pg_max_connections" /> [pg\_max\_connections](#input_pg_max_connections)

Description: The maximum number of connections to each postgres database

Type: `number`

Default: `100`

### <a name="input_pg_memory_mb" /> [pg\_memory\_mb](#input_pg_memory_mb)

Description: The amount of memory to allocate to the postgres pods (in Mi)

Type: `number`

Default: `1000`

### <a name="input_pg_parameters" /> [pg\_parameters](#input_pg_parameters)

Description: A map of postgres parameters. See [https://cloudnative-pg.io/documentation/1.23/postgresql\_conf](https://cloudnative-pg.io/documentation/1.23/postgresql_conf).

Type: `map(string)`

Default: `{}`

### <a name="input_pg_shared_buffers_percent" /> [pg\_shared\_buffers\_percent](#input_pg_shared_buffers_percent)

Description: The percent of the overall memory allocation dedicated for caching data (avoiding reads to disk)

Type: `number`

Default: `25`

### <a name="input_pg_smart_shutdown_timeout" /> [pg\_smart\_shutdown\_timeout](#input_pg_smart_shutdown_timeout)

Description: The number of seconds to wait for open connections to close before shutting down postgres nodes

Type: `number`

Default: `1`

### <a name="input_pg_storage_increase_gb" /> [pg\_storage\_increase\_gb](#input_pg_storage_increase_gb)

Description: The number of GB to increase storage by if free space drops below the threshold

Type: `number`

Default: `10`

### <a name="input_pg_storage_increase_threshold_percent" /> [pg\_storage\_increase\_threshold\_percent](#input_pg_storage_increase_threshold_percent)

Description: Dropping below this percent of free storage will trigger an automatic increase in storage size

Type: `number`

Default: `20`

### <a name="input_pg_storage_limit_gb" /> [pg\_storage\_limit\_gb](#input_pg_storage_limit_gb)

Description: The maximum number of gigabytes of storage to provision for the postgres cluster

Type: `number`

Default: `null`

### <a name="input_pg_switchover_delay" /> [pg\_switchover\_delay](#input_pg_switchover_delay)

Description: Controls max amount of time that CNPG will wait for data to be synced from primary to replica before forcing the switchover

Type: `number`

Default: `30`

### <a name="input_pg_version" /> [pg\_version](#input_pg_version)

Description: The version of postgres to deploy

Type: `string`

Default: `"16.2-10"`

### <a name="input_pg_work_mem_percent" /> [pg\_work\_mem\_percent](#input_pg_work_mem_percent)

Description: The percent of the overall memory allocation available to queries for sort and hash operations (intermediate calculations during queries)

Type: `number`

Default: `25`

### <a name="input_pgbouncer_application_name_add_host" /> [pgbouncer\_application\_name\_add\_host](#input_pgbouncer_application_name_add_host)

Description: Add the client host address and port to the application name setting set on connection start.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_autodb_idle_timeout" /> [pgbouncer\_autodb\_idle\_timeout](#input_pgbouncer_autodb_idle_timeout)

Description: If the automatically created (via “\*”) database pools have been unused this many seconds, they are freed.

Type: `number`

Default: `3600`

### <a name="input_pgbouncer_client_idle_timeout" /> [pgbouncer\_client\_idle\_timeout](#input_pgbouncer_client_idle_timeout)

Description: Client connections idling longer than this many seconds are closed. This should be larger than the client-side connection lifetime settings, and only used for network problems.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_client_login_timeout" /> [pgbouncer\_client\_login\_timeout](#input_pgbouncer_client_login_timeout)

Description: If a client connects but does not manage to log in in this amount of time, it will be disconnected. Mainly needed to avoid dead connections stalling SUSPEND and thus online restart.

Type: `number`

Default: `60`

### <a name="input_pgbouncer_default_pool_size" /> [pgbouncer\_default\_pool\_size](#input_pgbouncer_default_pool_size)

Description: How many server connections to allow per user/database pair.

Type: `number`

Default: `20`

### <a name="input_pgbouncer_disable_pqexec" /> [pgbouncer\_disable\_pqexec](#input_pgbouncer_disable_pqexec)

Description: Disable the Simple Query protocol (PQexec). Unlike the Extended Query protocol, Simple Query allows multiple queries in one packet, which allows some classes of SQL-injection attacks.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_log_connections" /> [pgbouncer\_log\_connections](#input_pgbouncer_log_connections)

Description: Whether to log each connection.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_log_disconnections" /> [pgbouncer\_log\_disconnections](#input_pgbouncer_log_disconnections)

Description: Whether to log each disconnection.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_log_pooler_errors" /> [pgbouncer\_log\_pooler\_errors](#input_pgbouncer_log_pooler_errors)

Description: Whether to log errors the pooler sends to clients.

Type: `bool`

Default: `true`

### <a name="input_pgbouncer_max_client_conn" /> [pgbouncer\_max\_client\_conn](#input_pgbouncer_max_client_conn)

Description: The maximum client connections allowed by pgbouncer

Type: `number`

Default: `10000`

### <a name="input_pgbouncer_max_db_connections" /> [pgbouncer\_max\_db\_connections](#input_pgbouncer_max_db_connections)

Description: Do not allow more than this many server connections per database (regardless of user). This considers the PgBouncer database that the client has connected to, not the PostgreSQL database of the outgoing connection.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_max_prepared_statements" /> [pgbouncer\_max\_prepared\_statements](#input_pgbouncer_max_prepared_statements)

Description: When this is set to a non-zero value PgBouncer tracks protocol-level named prepared statements related commands sent by the client in transaction and statement pooling mode. PgBouncer makes sure that any statement prepared by a client is available on the backing server connection. Even when the statement was originally prepared on another server connection.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_max_user_connections" /> [pgbouncer\_max\_user\_connections](#input_pgbouncer_max_user_connections)

Description: Do not allow more than this many server connections per user (regardless of database).

Type: `number`

Default: `0`

### <a name="input_pgbouncer_min_pool_size" /> [pgbouncer\_min\_pool\_size](#input_pgbouncer_min_pool_size)

Description: Add more server connections to pool if below this number. Improves behavior when the normal load suddenly comes back after a period of total inactivity. The value is effectively capped at the pool size.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_pool_mode" /> [pgbouncer\_pool\_mode](#input_pgbouncer_pool_mode)

Description: What pool\_mode to run pgbouncer in

Type: `string`

Default: `"session"`

### <a name="input_pgbouncer_query_timeout" /> [pgbouncer\_query\_timeout](#input_pgbouncer_query_timeout)

Description: Queries running longer than this amount of seconds are canceled. This should be used only with a slightly smaller server-side statement\_timeout, to apply only for network problems.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_query_wait_timeout" /> [pgbouncer\_query\_wait\_timeout](#input_pgbouncer_query_wait_timeout)

Description: Maximum time queries are allowed to spend waiting for execution. If the query is not assigned to a server during that time, the client is disconnected. 0 disables. If this is disabled, clients will be queued indefinitely.

Type: `number`

Default: `120`

### <a name="input_pgbouncer_read_only_enabled" /> [pgbouncer\_read\_only\_enabled](#input_pgbouncer_read_only_enabled)

Description: Whether to enable a pgbouncer deployment in read-only mode

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_read_write_enabled" /> [pgbouncer\_read\_write\_enabled](#input_pgbouncer_read_write_enabled)

Description: Whether to enable a pgbouncer deployment in read-write mode

Type: `bool`

Default: `true`

### <a name="input_pgbouncer_reserve_pool_size" /> [pgbouncer\_reserve\_pool\_size](#input_pgbouncer_reserve_pool_size)

Description: How many additional connections to allow to a pool (see reserve\_pool\_timeout). 0 disables.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_reserve_pool_timeout" /> [pgbouncer\_reserve\_pool\_timeout](#input_pgbouncer_reserve_pool_timeout)

Description: If a client has not been serviced in this amount of seconds, use additional connections from the reserve pool. 0 disables.

Type: `number`

Default: `5`

### <a name="input_pgbouncer_server_check_delay" /> [pgbouncer\_server\_check\_delay](#input_pgbouncer_server_check_delay)

Description: How long to keep released connections available for immediate re-use.

Type: `number`

Default: `30`

### <a name="input_pgbouncer_server_connect_timeout" /> [pgbouncer\_server\_connect\_timeout](#input_pgbouncer_server_connect_timeout)

Description: If connection and login don’t finish in this amount of seconds, the connection will be closed.

Type: `number`

Default: `15`

### <a name="input_pgbouncer_server_fast_close" /> [pgbouncer\_server\_fast\_close](#input_pgbouncer_server_fast_close)

Description: Disconnect a server in session pooling mode immediately or after the end of the current transaction if it is in “close\_needed” mode (set by RECONNECT, RELOAD that changes connection settings, or DNS change), rather than waiting for the session end. In statement or transaction pooling mode, this has no effect since that is the default behavior there.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_server_idle_timeout" /> [pgbouncer\_server\_idle\_timeout](#input_pgbouncer_server_idle_timeout)

Description: If a server connection has been idle more than this many seconds it will be closed. If 0 then this timeout is disabled.

Type: `number`

Default: `600`

### <a name="input_pgbouncer_server_lifetime" /> [pgbouncer\_server\_lifetime](#input_pgbouncer_server_lifetime)

Description: The pooler will close an unused (not currently linked to any client connection) server connection that has been connected longer than this. Setting it to 0 means the connection is to be used only once, then closed.

Type: `number`

Default: `3600`

### <a name="input_pgbouncer_server_login_retry" /> [pgbouncer\_server\_login\_retry](#input_pgbouncer_server_login_retry)

Description: If login to the server failed, because of failure to connect or from authentication, the pooler waits this many seconds before retrying to connect. During the waiting interval, new clients trying to connect to the failing server will get an error immediately without another connection attempt.

Type: `number`

Default: `15`

### <a name="input_pgbouncer_stats_period" /> [pgbouncer\_stats\_period](#input_pgbouncer_stats_period)

Description: Sets how often the averages shown in various SHOW commands are updated and how often aggregated statistics are written to the log.

Type: `number`

Default: `60`

### <a name="input_pgbouncer_tcp_keepalive" /> [pgbouncer\_tcp\_keepalive](#input_pgbouncer_tcp_keepalive)

Description: Turns on basic keepalive with OS defaults.

Type: `bool`

Default: `true`

### <a name="input_pgbouncer_tcp_keepcnt" /> [pgbouncer\_tcp\_keepcnt](#input_pgbouncer_tcp_keepcnt)

Description: Sets tcp\_keepcnt

Type: `number`

Default: `null`

### <a name="input_pgbouncer_tcp_keepidle" /> [pgbouncer\_tcp\_keepidle](#input_pgbouncer_tcp_keepidle)

Description: Sets tcp\_keepidle

Type: `number`

Default: `null`

### <a name="input_pgbouncer_tcp_keepintvl" /> [pgbouncer\_tcp\_keepintvl](#input_pgbouncer_tcp_keepintvl)

Description: Sets tcp\_keepintvl

Type: `number`

Default: `null`

### <a name="input_pgbouncer_tcp_user_timeout" /> [pgbouncer\_tcp\_user\_timeout](#input_pgbouncer_tcp_user_timeout)

Description: Sets the TCP\_USER\_TIMEOUT socket option. This specifies the maximum amount of time in milliseconds that transmitted data may remain unacknowledged before the TCP connection is forcibly closed. If set to 0, then operating system’s default is used.

Type: `bool`

Default: `false`

### <a name="input_pgbouncer_verbose" /> [pgbouncer\_verbose](#input_pgbouncer_verbose)

Description: Increase verbosity. Mirrors the “-v” switch on the command line. For example, using “-v -v” on the command line is the same as verbose=2.

Type: `number`

Default: `0`

### <a name="input_pgbouncer_version" /> [pgbouncer\_version](#input_pgbouncer_version)

Description: The version of the cloudnative-pg/pgbouncer image to use

Type: `string`

Default: `"1.22.1"`

### <a name="input_pull_through_cache_enabled" /> [pull\_through\_cache\_enabled](#input_pull_through_cache_enabled)

Description: Whether to use the ECR pull through cache for the deployed images

Type: `bool`

Default: `false`

### <a name="input_spot_instances_enabled" /> [spot\_instances\_enabled](#input_spot_instances_enabled)

Description: Whether the database nodes can be scheduled on spot instances

Type: `bool`

Default: `false`

### <a name="input_voluntary_disruption_window_cron_schedule" /> [voluntary\_disruption\_window\_cron\_schedule](#input_voluntary_disruption_window_cron_schedule)

Description: The times when disruption windows should start

Type: `string`

Default: `"0 4 * * *"`

### <a name="input_voluntary_disruption_window_enabled" /> [voluntary\_disruption\_window\_enabled](#input_voluntary_disruption_window_enabled)

Description: Whether to confine voluntary disruptions of pods in this module to specific time windows

Type: `bool`

Default: `false`

### <a name="input_voluntary_disruption_window_seconds" /> [voluntary\_disruption\_window\_seconds](#input_voluntary_disruption_window_seconds)

Description: The length of the disruption window in seconds

Type: `number`

Default: `3600`

### <a name="input_voluntary_disruptions_enabled" /> [voluntary\_disruptions\_enabled](#input_voluntary_disruptions_enabled)

Description: Whether to enable voluntary disruptions of pods in this module.

Type: `bool`

Default: `true`

### <a name="input_vpa_enabled" /> [vpa\_enabled](#input_vpa_enabled)

Description: Whether to enable the vertical pod autoscaler

Type: `bool`

Default: `true`

## Outputs

The following outputs are exported:

### <a name="output_cluster_match_labels" /> [cluster\_match\_labels](#output_cluster_match_labels)

Description: Label selector that matches all PostgreSQL pods

### <a name="output_cluster_ro_match_labels" /> [cluster\_ro\_match\_labels](#output_cluster_ro_match_labels)

Description: Label selector that matches all read-only replica PostgreSQL pods

### <a name="output_cluster_rw_match_labels" /> [cluster\_rw\_match\_labels](#output_cluster_rw_match_labels)

Description: Label selector that matches the primary PostgreSQL pod (the read-write node)

### <a name="output_database" /> [database](#output_database)

Description: The database to use for application data

### <a name="output_db_admin_role" /> [db\_admin\_role](#output_db_admin_role)

Description: The Vault role used to get admin credentials for the created PostgreSQL cluster

### <a name="output_db_reader_role" /> [db\_reader\_role](#output_db_reader_role)

Description: The Vault role used to get read-only credentials for the created PostgreSQL cluster

### <a name="output_db_superuser_role" /> [db\_superuser\_role](#output_db_superuser_role)

Description: The Vault role used to get superuser credentials for the created PostgreSQL cluster

### <a name="output_namespace" /> [namespace](#output_namespace)

Description: The Kubernetes namespace for the created resources

### <a name="output_pooler_r_match_labels" /> [pooler\_r\_match\_labels](#output_pooler_r_match_labels)

Description: Label selector that matches all PgBouncer pods that allows read-only access to the PostgreSQL cluster

### <a name="output_pooler_r_service_name" /> [pooler\_r\_service\_name](#output_pooler_r_service_name)

Description: The service name of the PgBouncer connection pooler that allows read-only access

### <a name="output_pooler_r_service_port" /> [pooler\_r\_service\_port](#output_pooler_r_service_port)

Description: The PostgreSQL port for this service

### <a name="output_pooler_rw_match_labels" /> [pooler\_rw\_match\_labels](#output_pooler_rw_match_labels)

Description: Label selector that matches all PgBouncer pods that allows read-write access to the PostgreSQL cluster

### <a name="output_pooler_rw_service_name" /> [pooler\_rw\_service\_name](#output_pooler_rw_service_name)

Description: The service name of the PgBouncer connection pooler that allows read-write access

### <a name="output_pooler_rw_service_port" /> [pooler\_rw\_service\_port](#output_pooler_rw_service_port)

Description: The PostgreSQL port for this service

### <a name="output_r_service_name" /> [r\_service\_name](#output_r_service_name)

Description: The service name for all db instances that allows read access (includes read-write instances as well)

### <a name="output_r_service_port" /> [r\_service\_port](#output_r_service_port)

Description: The PostgreSQL port for this service

### <a name="output_ro_service_name" /> [ro\_service\_name](#output_ro_service_name)

Description: The service name for the db instances that allows read-only access

### <a name="output_ro_service_port" /> [ro\_service\_port](#output_ro_service_port)

Description: The PostgreSQL port for this service

### <a name="output_rw_service_name" /> [rw\_service\_name](#output_rw_service_name)

Description: The service name of the db node that allows read-write access

### <a name="output_rw_service_port" /> [rw\_service\_port](#output_rw_service_port)

Description: The PostgreSQL port for this service

### <a name="output_server_certs_secret" /> [server\_certs\_secret](#output_server_certs_secret)

Description: The secret containing the server certificates for the database

### <a name="output_superuser_password" /> [superuser\_password](#output_superuser_password)

Description: The password for root user of the database

### <a name="output_superuser_username" /> [superuser\_username](#output_superuser_username)

Description: The root user of the database

## Maintenance Notes

No notes

{/* eslint-enable import/order */}

{/* lint enable no-duplicate-headings */}
