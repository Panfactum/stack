import ModuleHeader from "../../../ModuleHeader";

{/* lint disable no-duplicate-headings */}

{/* eslint-disable import/order */}

<ModuleHeader name="aws_cdn" sourceHref="https://github.com/Panfactum/stack/tree/__PANFACTUM_VERSION_MAIN__/packages/infrastructure/aws_cdn" status="beta" type="submodule" />

# AWS CDN

Deploys an [AWS CloudFront distribution](https://docs.aws.amazon.com/AmazonCloudFront/latest/DeveloperGuide/Introduction.html)
([CDN](https://en.wikipedia.org/wiki/Content_delivery_network)) that can be used to proxy requests to your upstream origins.

This module performs several functions in addition to providing sensible defaults for the CDN:

* Sets up the CDN TLS certificates
* Sets up the DNS records for the CDN
* Provides pre-packaged edge function behaviors (e.g., URL rewrite rules)
* Allows for request logging

## Limitations

1. The domain names used for the CDN must be served by Route53 zones in the AWS account within which this module
   is deployed. This is because this module automatically configures all the necessary DNS settings.

## Usage

## Providers

The following providers are needed by this module:

* archive (2.6.0)

* [aws](https://registry.terraform.io/providers/hashicorp/aws/5.70.0/docs) (5.70.0)

* [random](https://registry.terraform.io/providers/hashicorp/random/3.6.0/docs) (3.6.0)

## Required Inputs

The following input variables are required:

### domains

Description: A list of domains to use for the CDN

Type: `list(string)`

### name

Description: The name of the CDN that will get created

Type: `string`

### origin\_configs

Description: A list of configuration settings for communicating with the upstream origins

Type:

```hcl
list(object({
    origin_id            = optional(string)          # A globally unique identifier for this origin (will be automatically computed if not provided)
    origin_domain        = string                    # The domain name of the ingress origin
    path_prefix          = optional(string, "/")     # Only traffic with this HTTP path prefix will be routed to the indicated origin
    extra_origin_headers = optional(map(string), {}) # Headers sent from the CDN to the origin

    # The default behavior of the CDN before routing requests to this origin
    default_cache_behavior = optional(object({
      caching_enabled      = optional(bool, true)                                                                 # Whether the CDN should cache responses from the origin (overrides all other caching settings)
      allowed_methods      = optional(list(string), ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"]) # What HTTP methods are allowed
      cached_methods       = optional(list(string), ["GET", "HEAD"])                                              # What HTTP methods will be cached
      min_ttl              = optional(number, 0)                                                                  # Minimum cache time
      default_ttl          = optional(number, 86400)                                                              # Default cache time
      max_ttl              = optional(number, 31536000)                                                           # Maximum cache time
      cookies_in_cache_key = optional(list(string), ["*"])                                                        # Which cookies will be included in the cache key (Providing "*" means ALL cookies)
      headers_in_cache_key = optional(list(string), [                                                             # Which headers will be included in the cache key
        "Authorization",
        "Origin",
        "x-http-method-override",
        "x-http-method",
        "x-method-override",
        "x-forwarded-host",
        "x-host",
        "x-original-url",
        "x-rewrite-url",
        "forwarded"
      ])
      query_strings_in_cache_key  = optional(list(string), ["*"])         # Which query strings will be included in the cache key (Providing "*" means ALL query strings)
      cookies_not_forwarded       = optional(list(string), [])            # Which cookies will NOT be forwarded to the ingress from the CDN
      headers_not_forwarded       = optional(list(string), [])            # Which headers will NOT be forwarded to the ingress from CDN
      query_strings_not_forwarded = optional(list(string), [])            # Which query strings will NOT be forwarded to the ingress from the CDN
      compression_enabled         = optional(bool, true)                  # Whether the CDN performs compression on your assets
      viewer_protocol_policy      = optional(string, "redirect-to-https") # What should happen based on the client protocol (HTTP vs HTTPS)
    }))

    # Similar to default_cache_behavior but allows you to specific specific rules for certain path patterns
    # The keys for this map are the path patterns (e.g., "*.jpg")
    # Path patterns will automatically be prefixed with the path_prefix value, so it can be omitted
    path_match_behavior = optional(map(object({
      caching_enabled      = optional(bool, true)
      allowed_methods      = optional(list(string), ["DELETE", "GET", "HEAD", "OPTIONS", "PATCH", "POST", "PUT"])
      cached_methods       = optional(list(string), ["GET", "HEAD"])
      min_ttl              = optional(number, 0)
      default_ttl          = optional(number, 86400)
      max_ttl              = optional(number, 31536000)
      cookies_in_cache_key = optional(list(string), ["*"])
      headers_in_cache_key = optional(list(string), [
        "Authorization",
        "Origin",
        "x-http-method-override",
        "x-http-method",
        "x-method-override",
        "x-forwarded-host",
        "x-host",
        "x-original-url",
        "x-rewrite-url",
        "forwarded"
      ])
      query_strings_in_cache_key  = optional(list(string), ["*"])
      cookies_not_forwarded       = optional(list(string), [])
      headers_not_forwarded       = optional(list(string), [])
      query_strings_not_forwarded = optional(list(string), [])
      compression_enabled         = optional(bool, true)
      viewer_protocol_policy      = optional(string, "redirect-to-https")
    })), {})
  }))
```

## Optional Inputs

The following input variables are optional (have default values):

### geo\_restriction\_list

Description: A list of ISO 3166 country codes for the geographic restriction list (works for both whitelist and blacklist)

Type: `list(string)`

Default: `[]`

### geo\_restriction\_type

Description: What type of geographic restrictions to you want to apply to CDN clients

Type: `string`

Default: `"none"`

### origin\_shield\_enabled

Description: Whether origin shield should be enabled for the CloudFront distribution

Type: `bool`

Default: `false`

### price\_class

Description: The price class for the CDN

Type: `string`

Default: `"PriceClass_100"`

### redirect\_rules

Description: A list of redirect rules that the ingress will match against before sending requests to the upstreams

Type:

```hcl
list(object({
    source    = string                # A regex string for matching the entire request url (^https://domain.com(/.*)?$)
    target    = string                # The redirect target (can use numbered capture groups from the source - https://domain2.com/$1)
    permanent = optional(bool, false) # If true will issue a 301 redirect; otherwise, will use 302
  }))
```

Default: `[]`

## Outputs

No outputs.

## Maintainer Notes

No notes.

{/* eslint-enable import/order */}

{/* lint enable no-duplicate-headings */}
