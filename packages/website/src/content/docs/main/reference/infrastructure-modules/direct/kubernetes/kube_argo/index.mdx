import ModuleHeader from "@/components/markdown/ModuleHeader.astro";

{/* lint disable no-duplicate-headings */}

{/* eslint-disable import/order */}
<ModuleHeader name="kube_argo" sourceHref="https://github.com/Panfactum/stack/tree/__PANFACTUM_VERSION_MAIN__/packages/infrastructure/kube_argo" status="beta" type="direct"/>

# Argo Workflows

This module deploys Argo Workflows, a workflow engine for orchestrating parallel jobs on Kubernetes. It also includes Argo Events, which allows event-driven workflow automation.

## Features

- Argo Workflows for workflow orchestration
- Argo Events for event-driven workflow automation
- Integration with PostgreSQL for persistent workflow storage
- Secure by default with RBAC configuration
- Optional metric endpoints for Prometheus monitoring

## Usage

```hcl
module "argo" {
  source = "../kube_argo"
  argo_domain = "argo.example.com"
  vault_domain = "vault.example.com"
  # Enable monitoring
  monitoring_enabled = true
  metrics_enabled = true
  service_monitor_enabled = true
  service_monitor_namespace = "monitoring"
  service_monitor_labels = {
    "release" = "prometheus"
  }
}
```

## Prometheus Metrics

This module can expose Prometheus metrics for both Argo Workflows and Argo Events. To enable metrics:

1. Set `metrics_enabled = true` to expose the metrics endpoints
2. Set `service_monitor_enabled = true` to create ServiceMonitor resources for Prometheus Operator
3. Configure `service_monitor_namespace` and `service_monitor_labels` as needed for your Prometheus setup

```hcl
module "argo" {
  source = "../kube_argo"
  argo_domain = "argo.example.com"
  vault_domain = "vault.example.com"
  # Enable metrics
  metrics_enabled = true
  service_monitor_enabled = true
  service_monitor_namespace = "monitoring"
  service_monitor_labels = {
    "release" = "prometheus"
  }
  # Optional: customize metrics configuration
  metrics_service_port = 9090
  metrics_service_port_name = "metrics"
  metrics_path = "/metrics"
  metrics_scrape_interval = "30s"
}
```

### Metrics Configuration Details

The metrics configuration is applied differently for Argo Workflows and Argo Events:

- **Argo Workflows**: Metrics are configured at the controller level using the `metricsConfig` section
- **Argo Events**: Metrics are configured separately for both the controller and webhook components

Both components will expose metrics endpoints when enabled, and ServiceMonitor resources will be created if configured.

### Available Metrics

When enabled, the following types of metrics are available:

- Workflow execution metrics (counts, durations)
- Controller metrics (operation latencies, queue sizes)
- Event processing metrics (event counts, trigger counts)
- Custom workflow metrics (can be defined in workflow templates)

### Monitoring Dashboard

For a comprehensive monitoring dashboard, you can use the [Argo Workflows Grafana Dashboard](https://grafana.com/grafana/dashboards/13927-argoworkflow-metrics/).

## Variables

| Name | Description | Type | Default |
|------|-------------|------|---------|
| argo\_domain | The domain to use for the Argo UI | string | n/a |
| vault\_domain | The domain of the Vault instance running in the cluster | string | n/a |
| metrics\_enabled | Whether to enable Prometheus metrics | bool | false |
| metrics\_service\_port | Service port for the metrics endpoint | number | 9090 |
| metrics\_service\_port\_name | Service port name for the metrics endpoint | string | "metrics" |
| metrics\_path | The path where metrics are exposed | string | "/metrics" |
| metrics\_scrape\_interval | How frequently Prometheus should scrape metrics | string | "30s" |
| service\_monitor\_enabled | Whether to create ServiceMonitor resources | bool | false |
| service\_monitor\_namespace | Namespace for ServiceMonitor resources | string | "" |
| service\_monitor\_labels | Additional labels for ServiceMonitor resources | map(string) | {} |
| monitoring\_enabled | Whether to add active monitoring to the deployed systems | bool | false |
| sla\_target | SLA level (1-3) | number | 3 |

## Providers

The following providers are needed by this module:

- [helm](https://registry.terraform.io/providers/hashicorp/helm/2.12.1/docs) (2.12.1)

- [kubectl](https://registry.terraform.io/providers/alekc/kubectl/2.1.3/docs) (2.1.3)

- [kubernetes](https://registry.terraform.io/providers/hashicorp/kubernetes/2.34.0/docs) (2.34.0)

- [pf](https://registry.terraform.io/providers/panfactum/pf/0.0.7/docs) (0.0.7)

- [random](https://registry.terraform.io/providers/hashicorp/random/3.6.3/docs) (3.6.3)

- [time](https://registry.terraform.io/providers/hashicorp/time/0.10.0/docs) (0.10.0)

- [vault](https://registry.terraform.io/providers/hashicorp/vault/4.5.0/docs) (4.5.0)

## Required Inputs

The following input variables are required:

### argo\_domain

Description: The domain to use for the argo UI. Must be in a subdomain available to the environment.

Type: `string`

### vault\_domain

Description: The domain of the Vault instance running in the cluster.

Type: `string`

## Optional Inputs

The following input variables are optional (have default values):

### argo\_events\_helm\_version

Description: The version of the argo events helm chart to deploy

Type: `string`

Default: `"2.4.9"`

### argo\_workflows\_helm\_version

Description: The version of the argo workflows helm chart to deploy

Type: `string`

Default: `"0.45.1"`

### aws\_iam\_ip\_allow\_list

Description: A list of IPs that can use the service account token to authenticate with AWS API

Type: `list(string)`

Default: `[]`

### burstable\_nodes\_enabled

Description: Whether to allow pods to schedule on burstable nodes

Type: `bool`

Default: `true`

### controller\_nodes\_enabled

Description: Whether to allow pods to schedule on EKS Node Group nodes (controller nodes)

Type: `bool`

Default: `true`

### db\_backup\_directory

Description: The name of the directory in the backup bucket containing the backups files for the database.

Type: `string`

Default: `"initial"`

### db\_recovery\_directory

Description: The name of the directory in the backup bucket that contains the PostgreSQL backups and WAL archives

Type: `string`

Default: `null`

### db\_recovery\_mode\_enabled

Description: Whether to enable recovery mode for the PostgreSQL database

Type: `bool`

Default: `false`

### db\_recovery\_target\_time

Description: If provided, will recover the PostgreSQL database to the indicated target time in RFC 3339 format rather than to the latest data.

Type: `string`

Default: `null`

### ingress\_enabled

Description: Whether or not to enable the ingress for routing traffic to argo

Type: `bool`

Default: `true`

### log\_level

Description: The log level for the argo pods

Type: `string`

Default: `"info"`

### metrics\_enabled

Description: Whether to enable Prometheus metrics for Argo Workflows controller

Type: `bool`

Default: `false`

### metrics\_path

Description: The path where metrics are exposed

Type: `string`

Default: `"/metrics"`

### metrics\_scrape\_interval

Description: How frequently Prometheus should scrape the metrics endpoint

Type: `string`

Default: `"30s"`

### metrics\_service\_port

Description: Service port for the metrics endpoint

Type: `number`

Default: `9090`

### metrics\_service\_port\_name

Description: Service port name for the metrics endpoint

Type: `string`

Default: `"metrics"`

### monitoring\_enabled

Description: Whether to add active monitoring to the deployed systems

Type: `bool`

Default: `false`

### panfactum\_scheduler\_enabled

Description: Whether to use the Panfactum pod scheduler with enhanced bin-packing

Type: `bool`

Default: `false`

### pg\_maximum\_cpu\_millicores

Description: The maximum amount of cpu to allocate to the postgres pods (in millicores)

Type: `number`

Default: `10000`

### pg\_maximum\_memory\_mb

Description: The maximum amount of memory to allocate to the postgres pods (in Mi)

Type: `number`

Default: `128000`

### pg\_minimum\_cpu\_millicores

Description: The minimum amount of cpu to allocate to the postgres pods (in millicores)

Type: `number`

Default: `50`

### pg\_minimum\_cpu\_update\_millicores

Description: The CPU settings for the Postgres won't be updated until the recommendations from the VPA (if enabled) differ from the current settings by at least this many millicores. This prevents autoscaling thrash.

Type: `number`

Default: `250`

### pg\_minimum\_memory\_mb

Description: The minimum amount of memory to allocate to the postgres pods (in Mi)

Type: `number`

Default: `500`

### pgbouncer\_maximum\_cpu\_millicores

Description: The maximum amount of cpu to allocate to the pgbouncer pods (in millicores)

Type: `number`

Default: `10000`

### pgbouncer\_maximum\_memory\_mb

Description: The maximum amount of memory to allocate to the pgbouncer pods (in Mi)

Type: `number`

Default: `32000`

### pgbouncer\_minimum\_cpu\_millicores

Description: The minimum amount of cpu to allocate to the pgbouncer pods (in millicores)

Type: `number`

Default: `15`

### pgbouncer\_minimum\_memory\_mb

Description: The minimum amount of memory to allocate to the pgbouncer pods (in Mi)

Type: `number`

Default: `25`

### pull\_through\_cache\_enabled

Description: Whether to use the ECR pull through cache for the deployed images

Type: `bool`

Default: `true`

### service\_monitor\_enabled

Description: Whether to create a ServiceMonitor custom resource for Prometheus Operator

Type: `bool`

Default: `false`

### service\_monitor\_labels

Description: Additional labels to add to the ServiceMonitor

Type: `map(string)`

Default: `{}`

### service\_monitor\_namespace

Description: The namespace where the ServiceMonitor should be created

Type: `string`

Default: `""`

### sla\_target

Description: The Panfactum SLA level for the module deployment. 1 = lowest uptime (99.9%), lowest cost -- 3 = highest uptime (99.999%), highest Cost

Type: `number`

Default: `3`

### spot\_nodes\_enabled

Description: Whether to allow pods to schedule on spot nodes

Type: `bool`

Default: `true`

### test\_workflow\_enabled

Description: Whether to enable the test WorkflowTemplate

Type: `bool`

Default: `false`

### vpa\_enabled

Description: Whether the VPA resources should be enabled

Type: `bool`

Default: `true`

### wait

Description: Wait for resources to be in a ready state before proceeding. Disabling this flag will allow upgrades to proceed faster but will disable automatic rollbacks. As a result, manual intervention may be required for deployment failures.

Type: `bool`

Default: `true`

### workflow\_archive\_ttl

Description: Length of time that previously run workflow states are stored

Type: `string`

Default: `"60d"`

## Outputs

The following outputs are exported:

### artifact\_bucket\_arn

Description: ARN of the S3 bucket holding workflow artifacts

### artifact\_bucket\_name

Description: Name of the S3 bucket holding workflow artifacts

### db\_backup\_bucket

Description: The name of the S3 bucket that contains the PostgreSQL backups and WAL archives

### db\_backup\_directory

Description: The name of the directory in the backup bucket that contains the PostgreSQL backups and WAL archives

## Usage

No notes

{/* eslint-enable import/order */}

{/* lint enable no-duplicate-headings */}
